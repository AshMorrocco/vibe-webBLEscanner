<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Monitor + Test Suite</title>
    <style>
        :root {
            /* Default Dark Theme */
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-dim: #bbbbbb;
            --border-dim: #333333;
            --accent: #03dac6;
            --accent-glow: rgba(3, 218, 198, 0.1);
            --accent-badge: #003d33;
            --warn: #cf6679;
        }

        body.light-mode {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #1c1e21;
            --text-dim: #65676b;
            --border-dim: #dcdcdc;
            --accent-badge: #e0f7fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            padding-bottom: 80px;
            transition: background-color 0.3s, color 0.3s;
        }

        header {
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-dim); padding-bottom: 20px; margin-bottom: 20px;
        }

        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; }

        .status-badge {
            font-size: 0.8rem; padding: 4px 8px; border-radius: 4px;
            background: var(--border-dim); color: var(--text-dim); margin-left: 10px; transition: all 0.3s;
        }
        .status-badge.active { background: var(--accent-badge); color: var(--accent); border: 1px solid var(--accent); }
        .status-badge.test-mode { background: #b98e04; color: #000; border: 1px solid #ffcc00; }

        button {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 8px 24px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: all 0.2s;
        }
        button:hover { background: var(--accent-glow); }
        button:disabled { border-color: var(--border-dim); color: var(--border-dim); cursor: not-allowed; opacity: 0.5; background: transparent; }

        #device-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
        .card {
            background: var(--card-bg); border-radius: 6px; padding: 12px;
            border: 1px solid var(--border-dim); display: flex; flex-direction: column; gap: 8px;
            transition: border-color 0.2s, background-color 0.3s;
        }
        .card.fresh { border-color: var(--accent); }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .device-name { font-weight: bold; color: var(--accent); font-size: 1rem; }
        .packet-count { 
            font-family: monospace; font-size: 0.8rem; background: var(--border-dim); 
            padding: 2px 6px; border-radius: 4px; color: var(--text-main); min-width: 80px; text-align: center;
        }
        .card-center {
            font-family: monospace; font-size: 0.75rem; color: var(--text-dim); text-align: center;
            background: rgba(128,128,128, 0.1); padding: 4px; border-radius: 4px; letter-spacing: 1px;
        }
        .rssi-container { display: flex; align-items: center; gap: 10px; margin-top: 2px; }
        .meter { flex-grow: 1; height: 6px; background: var(--border-dim); border-radius: 3px; overflow: hidden; }
        .fill { height: 100%; background: var(--accent); transition: width 0.2s; }
        .rssi-text { font-family: monospace; font-size: 0.8rem; color: var(--text-dim); min-width: 60px; text-align: right; }

        #fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 10px; }
        #fab-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--accent); color: var(--accent); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); padding: 0; }
        #fab-btn svg { width: 24px; height: 24px; fill: currentColor; }
        #settings-menu { background: var(--card-bg); border: 1px solid var(--border-dim); padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; flex-direction: column; gap: 12px; min-width: 150px; }
        #settings-menu.visible { display: flex; }
        .theme-row { display: flex; justify-content: space-between; align-items: center; gap: 10px;}
        .swatch { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .swatch:hover { transform: scale(1.1); }

        #test-results { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 2000; padding: 40px; box-sizing: border-box; 
            overflow-y: auto; font-family: monospace; 
        }
        .pass { color: #00ff9d; margin-bottom: 5px; }
        .fail { color: #ff0055; font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center">
        <h1>BLE Monitor</h1>
        <span id="status" class="status-badge">Idle</span>
    </div>
    <div>
        <button id="btn-start">Start Scanner</button>
        <button id="btn-stop" disabled>Stop</button>
    </div>
</header>

<div id="device-grid"></div>
<div id="test-results"></div>

<div id="fab-container">
    <button id="fab-btn" title="Settings">
        <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
    </button>
    <div id="settings-menu">
        <div class="theme-row"><span class="theme-label">Theme</span><button id="theme-toggle" style="padding:4px 10px; font-size:0.8rem;">Light</button></div>
        <div class="theme-row"><span class="theme-label">Color</span>
            <div class="color-options">
                <div class="swatch" style="background:#03dac6;" data-color="#03dac6" data-bg="#003d33"></div>
                <div class="swatch" style="background:#bb86fc;" data-color="#bb86fc" data-bg="#32004a"></div>
                <div class="swatch" style="background:#ff9800;" data-color="#ff9800" data-bg="#4a2c00"></div>
                <div class="swatch" style="background:#76ff03;" data-color="#76ff03" data-bg="#1b3300"></div>
            </div>
        </div>
        <div class="theme-row" style="margin-top:10px; padding-top:10px; border-top:1px solid #333">
             <a href="?test=true" style="color:var(--text-dim); text-decoration:none; font-size:0.8rem;">Run Test Suite</a>
        </div>
    </div>
</div>

<script>
    // ==========================================
    //       1. MOCK BLUETOOTH ADAPTER
    //    (Must run BEFORE application logic)
    // ==========================================
    const isTestMode = new URLSearchParams(window.location.search).has('test');
    let mockListener = null;

    if (isTestMode) {
        console.log("⚠️ TEST MODE: Overwriting Bluetooth API");
        
        // Define Mock Object
        const mockBluetooth = {
            requestDevice: async () => { console.log("[Mock] Picker opened"); return {}; },
            requestLEScan: async () => { console.log("[Mock] Scan started"); return { stop: () => console.log("[Mock] Scan stopped") }; },
            addEventListener: (type, fn) => { if(type === 'advertisementreceived') mockListener = fn; },
            removeEventListener: () => { mockListener = null; }
        };

        // FORCE overwrite the read-only navigator.bluetooth property
        try {
            Object.defineProperty(navigator, 'bluetooth', {
                value: mockBluetooth,
                writable: true,
                configurable: true
            });
        } catch(e) {
            console.error("Failed to inject mock:", e);
        }
    }

    // ==========================================
    //       2. APPLICATION LOGIC
    // ==========================================
    const btnStart = document.getElementById('btn-start');
    const btnStop = document.getElementById('btn-stop');
    const statusBadge = document.getElementById('status');
    const grid = document.getElementById('device-grid');
    const fabBtn = document.getElementById('fab-btn');
    const settingsMenu = document.getElementById('settings-menu');
    const themeToggle = document.getElementById('theme-toggle');
    const swatches = document.querySelectorAll('.swatch');
    const testResultsDiv = document.getElementById('test-results');

    let scan = null;
    let isScanning = false;
    let rateInterval = null;
    const deviceStats = new Map();

    // Theming
    const savedTheme = localStorage.getItem('ble-theme') || 'dark';
    const savedColor = localStorage.getItem('ble-color') || '#03dac6';
    const savedBg = localStorage.getItem('ble-color-bg') || '#003d33';
    if (savedTheme === 'light') enableLightMode();
    applyAccent(savedColor, savedBg);

    if (isTestMode) {
        testResultsDiv.style.display = 'block';
        statusBadge.textContent = "TEST MODE";
        statusBadge.classList.add('test-mode');
    }

    fabBtn.addEventListener('click', () => settingsMenu.classList.toggle('visible'));
    themeToggle.addEventListener('click', () => document.body.classList.contains('light-mode') ? disableLightMode() : enableLightMode());
    swatches.forEach(s => s.addEventListener('click', (e) => applyAccent(e.target.dataset.color, e.target.dataset.bg)));

    function enableLightMode() { document.body.classList.add('light-mode'); themeToggle.textContent = 'Dark'; localStorage.setItem('ble-theme', 'light'); }
    function disableLightMode() { document.body.classList.remove('light-mode'); themeToggle.textContent = 'Light'; localStorage.setItem('ble-theme', 'dark'); }
    function applyAccent(c, bg) { document.documentElement.style.setProperty('--accent', c); document.documentElement.style.setProperty('--accent-badge', bg); localStorage.setItem('ble-color', c); localStorage.setItem('ble-color-bg', bg); }

    // BLE Logic
    btnStart.addEventListener('click', async () => {
        try {
            if (!navigator.bluetooth) throw new Error("Bluetooth not supported");
            
            // This will now call our Mock if in test mode
            try { await navigator.bluetooth.requestDevice({ acceptAllDevices: true }); } catch (e) {}
            
            scan = await navigator.bluetooth.requestLEScan({ acceptAllAdvertisements: true, keepRepeatedDevices: true });
            isScanning = true;
            updateUIState(true);
            rateInterval = setInterval(calculateRates, 1000);
            navigator.bluetooth.addEventListener('advertisementreceived', onAdvertisement);
        } catch (error) {
            console.error(error);
            // Don't alert in test mode, just log
            if(!isTestMode) alert("Scan failed: " + error);
            updateUIState(false);
        }
    });

    btnStop.addEventListener('click', stopScan);

    function stopScan() {
        if (scan) { try{ scan.stop(); }catch(e){} navigator.bluetooth.removeEventListener('advertisementreceived', onAdvertisement); scan = null; }
        if (rateInterval) { clearInterval(rateInterval); rateInterval = null; }
        isScanning = false;
        updateUIState(false);
    }

    function updateUIState(running) {
        if (running) {
            btnStart.disabled = true; btnStop.disabled = false;
            if(!isTestMode) { statusBadge.textContent = "Scanning Active"; statusBadge.classList.add("active"); }
        } else {
            btnStart.disabled = false; btnStop.disabled = true;
            if(!isTestMode) { statusBadge.textContent = "Idle"; statusBadge.classList.remove("active"); }
        }
    }

    document.addEventListener("visibilitychange", () => { if (document.hidden && isScanning && !isTestMode) stopScan(); });
    window.addEventListener("blur", () => { if (isScanning && !isTestMode) stopScan(); });

    function calculateRates() {
        deviceStats.forEach((stats, id) => {
            stats.rate = stats.bucket; stats.bucket = 0;
            const badge = document.getElementById(`badge-${id}`);
            if (badge) badge.textContent = `Rx: ${stats.total} | ${stats.rate}/s`;
        });
    }

    function onAdvertisement(event) {
        const { device, rssi } = event;
        const id = device.id;
        const name = device.name || 'N/A';
        
        let stats = deviceStats.get(id);
        if (!stats) { stats = { total: 0, bucket: 0, rate: 0 }; deviceStats.set(id, stats); }
        stats.total++; stats.bucket++;

        let card = document.getElementById(id);
        if (!card) {
            card = document.createElement('div'); card.id = id; card.className = 'card';
            grid.appendChild(card); renderCardContent(card, id, name, rssi, stats);
        } else { renderCardContent(card, id, name, rssi, stats); }
        card.classList.remove('fresh'); void card.offsetWidth; card.classList.add('fresh');
    }

    function renderCardContent(card, id, name, rssi, stats) {
        const percent = Math.min(Math.max((rssi + 100) * 1.5, 0), 100);
        card.innerHTML = `<div class="card-header"><span class="device-name">${name}</span><span id="badge-${id}" class="packet-count">Rx: ${stats.total} | ${stats.rate}/s</span></div><div class="card-center">${id}</div><div class="rssi-container"><div class="meter"><div class="fill" style="width:${percent}%"></div></div><div class="rssi-text">${rssi} dBm</div></div>`;
    }

    // ==========================================
    //       3. TEST SUITE (RUNS AUTOMATICALLY)
    // ==========================================
    if (isTestMode) {
        const logTest = (msg, pass) => {
            const div = document.createElement('div');
            div.textContent = (pass ? "✅ PASS: " : "❌ FAIL: ") + msg;
            div.className = pass ? 'pass' : 'fail';
            testResultsDiv.appendChild(div);
        };
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        (async () => {
            await sleep(500);
            logTest("Test Suite Starting...", true);

            // Test 1: Button Initial State
            if (!btnStart.disabled && btnStop.disabled) logTest("Buttons in IDLE state", true);
            else logTest("Buttons wrong state", false);

            // Test 2: Start Scan (Should use Mock, no Security Error)
            btnStart.click();
            await sleep(100); 
            if (btnStart.disabled && !btnStop.disabled) logTest("Scan started (UI updated)", true);
            else logTest("Start button failed to toggle", false);

            // Test 3: Inject Data
            if (mockListener) {
                mockListener({ device: { id: "TEST_001", name: "Mock Device" }, rssi: -50 });
                logTest("Injected mock packet", true);
            } else { logTest("Listener not attached!", false); }

            await sleep(100);
            const card = document.getElementById("TEST_001");
            if (card) logTest("Card rendered in DOM", true);
            else logTest("Card failed to render", false);

            // Test 4: Counters
            if (mockListener) {
                mockListener({ device: { id: "TEST_001", name: "Mock Device" }, rssi: -50 });
                mockListener({ device: { id: "TEST_001", name: "Mock Device" }, rssi: -50 });
            }
            await sleep(100);
            // Should be 3 packets total
            if (card && card.innerHTML.includes("Rx: 3")) logTest("Rx Counter increments correctly (3)", true);
            else logTest("Rx Counter incorrect", false);

            // Test 5: Rate Calc
            logTest("Waiting 1.1s for rate calculator...", true);
            await sleep(1100);
            
            // UPDATED: Now expecting 3/s because all mock events happened in same second
            if (card && card.innerHTML.includes("3/s")) logTest("Rate calculated correctly (3/s)", true);
            else logTest("Rate calculation failed", false);

            // Test 6: Stop
            btnStop.click();
            await sleep(100);
            if (!btnStart.disabled && btnStop.disabled) logTest("Stop button reset UI", true);
            else logTest("Stop logic failed", false);

            // Done
            logTest("___ SUITE COMPLETE ___", true);
            const closeBtn = document.createElement('button');
            closeBtn.textContent = "Exit Test Mode";
            closeBtn.style.marginTop = "20px";
            closeBtn.onclick = () => window.location.href = window.location.pathname;
            testResultsDiv.appendChild(closeBtn);
        })();
    }
</script>
</body>
</html>